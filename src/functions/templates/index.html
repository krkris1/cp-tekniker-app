<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Device Management</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    h2 {
      text-align: center;
    }

    input, button, textarea {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 1em;
    }

    button {
      background-color: #007BFF;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover:enabled {
      background-color: #0056b3;
    }

    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }

    .hidden {
      display: none;
    }

    /* Toast styles */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    .toast {
      background-color: #333;
      color: white;
      padding: 12px 20px;
      margin-bottom: 10px;
      border-radius: 4px;
      opacity: 0;
      transform: translateY(-10px);
      animation: fadeInOut 3s forwards;
      font-size: 0.95em;
    }

    .toast.success {
      background-color: #28a745;
    }

    .toast.error {
      background-color: #dc3545;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(-10px); }
      10%, 90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-10px); }
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>

  <div class="container">
    <h2>Login</h2>
    <div id="loginSection">
      <input type="email" id="loginEmail" placeholder="Skriv inn e-post" autofocus />
      <button id="requestAuthBtn" onclick="requestAuthCode()">Be om kode</button>
      <input type="text" id="authCode" inputmode="numeric" placeholder="Skriv inn kode (f.eks. 123-123)" maxlength="7" oninput="formatCodeInput(this)" />
      <button id="loginBtn" onclick="verifyAuthCode()">Logg inn</button>
    </div>

    <button id="logoutBtn" onclick="logout()" class="hidden">Logg ut</button>

    <div id="protectedContent" class="hidden">
      <h2>Hent enhetsinfo</h2>
      <input type="text" id="macaddr" placeholder="Skriv inn MAC-adresse" />
      <button id="getDeviceInfoBtn" onclick="getDeviceInfo()">Hent info</button>
      <pre id="getResult"></pre>

      <h2>Opprett enhet</h2>
      <label for="roleDropdown">Velg rolle:</label>
      <select id="roleDropdown"></select>
      <label for="visitorName">Navn på enhet:</label>
      <input type="text" id="visitorName" placeholder="Navn på enhet" />
      <label for="expireTime">Utløpstid (valgfritt):</label>
      <input type="datetime-local" id="expireTime" />
      <label for="enabledCheckbox">
        <input type="checkbox" id="enabledCheckbox" checked /> Aktivert
      </label>
      <button id="createDeviceBtn" onclick="createDevice()">Opprett enhet</button>
      <pre id="postResult"></pre>
    </div>
  </div>

  <script>
    function showToast(message, type = 'success') {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      toastContainer.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function disableButtons(ids, disabled = true) {
      ids.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.disabled = disabled;
      });
    }

    function getHttpStatusMessage(status) {
      switch (status) {
        case 400: return 'Ugyldig forespørsel.';
        case 401: return 'Du må være logget inn.';
        case 403: return 'Du har ikke tilgang.';
        case 404: return 'Ressurs ikke funnet.';
        case 500: return 'Intern serverfeil.';
        default: return `Feil (${status})`;
      }
    }

    function normalizeCodeInput(code) {
      // Accepts both 123456 and 123-456, returns 123-456
      code = code.replace(/[^0-9]/g, '');
      if (code.length === 6) {
        return code.slice(0, 3) + '-' + code.slice(3);
      }
      return code;
    }

    async function requestAuthCode() {
      const email = document.getElementById('loginEmail').value;
      showToast('Sender kode...');
      disableButtons(['requestAuthBtn'], true);
      try {
        const response = await fetch('/request_auth_code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await response.json();
        if (response.ok) {
          showToast(data.message || 'Kode sendt.');
        } else {
          const msg = data.error || getHttpStatusMessage(response.status);
          showToast(msg, 'error');
        }
      } catch (error) {
        showToast(`Nettverksfeil: ${error.message}`, 'error');
      }
      disableButtons(['requestAuthBtn'], false);
    }

    async function verifyAuthCode() {
      const email = document.getElementById('loginEmail').value;
      let code = document.getElementById('authCode').value;
      code = normalizeCodeInput(code);
      showToast('Verifiserer...');
      disableButtons(['loginBtn', 'requestAuthBtn'], true);
      try {
        const response = await fetch('/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, code })
        });
        const data = await response.json();
        if (response.ok) {
          showToast(data.message || 'Innlogging vellykket.');
          setLoggedIn(true);
          window.loggedInEmail = email;
        } else {
          const msg = data.error || getHttpStatusMessage(response.status);
          showToast(msg, 'error');
          setLoggedIn(false);
        }
      } catch (error) {
        showToast(`Nettverksfeil: ${error.message}`, 'error');
        setLoggedIn(false);
      }
      document.getElementById('authCode').value = '';
      disableButtons(['loginBtn', 'requestAuthBtn'], false);
    }

    async function logout() {
      disableButtons(['logoutBtn'], true);
      await fetch('/logout', { method: 'POST' });
      setLoggedIn(false);
      showToast('Du er logget ut.');
      disableButtons(['logoutBtn'], false);
    }

    async function fetchDeviceRoles() {
      try {
        const response = await fetch('/GetDeviceRoles');
        const data = await response.json();
        const dropdown = document.getElementById('roleDropdown');
        dropdown.innerHTML = '';
        if (Array.isArray(data) && data.length > 0) {
          data.forEach(role => {
            const option = document.createElement('option');
            option.value = role.role_id || role.id || role.name;
            option.textContent = role.name;
            dropdown.appendChild(option);
          });
        } else if (data._embedded && Array.isArray(data._embedded.items)) {
          data._embedded.items.forEach(role => {
            const option = document.createElement('option');
            option.value = role.role_id || role.id || role.name;
            option.textContent = role.name;
            dropdown.appendChild(option);
          });
        } else {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'Ingen roller funnet';
          dropdown.appendChild(option);
        }
      } catch (error) {
        const dropdown = document.getElementById('roleDropdown');
        dropdown.innerHTML = '';
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Feil ved henting av roller';
        dropdown.appendChild(option);
      }
    }

    function setLoggedIn(loggedIn) {
      document.getElementById('loginSection').classList.toggle('hidden', loggedIn);
      document.getElementById('logoutBtn').classList.toggle('hidden', !loggedIn);
      document.getElementById('protectedContent').classList.toggle('hidden', !loggedIn);
      if (loggedIn) fetchDeviceRoles();
    }

    async function getDeviceInfo() {
      const macaddr = document.getElementById('macaddr').value;
      const result = document.getElementById('getResult');
      result.textContent = 'Laster...';
      disableButtons(['getDeviceInfoBtn'], true);
      try {
        const response = await fetch(`/get_device_info?macaddr=${encodeURIComponent(macaddr)}`);
        const data = await response.json();

        if (!response.ok) {
          const userMsg = data.error || getHttpStatusMessage(response.status);
          showToast(userMsg, 'error');
          console.error('Serverfeil:', data.details || data);
          result.textContent = `Feil: ${userMsg}`;
        } else {
          result.textContent = JSON.stringify(data, null, 2);
          showToast('Enhetsinfo hentet.');
        }
      } catch (error) {
        result.textContent = `Feil: ${error.message}`;
        showToast('Nettverksfeil ved henting av enhetsinfo.', 'error');
        console.error('Uventet feil:', error);
      }
      disableButtons(['getDeviceInfoBtn'], false);
    }

    async function createDevice() {
      const mac = document.getElementById('macaddr').value.trim();
      const roleDropdown = document.getElementById('roleDropdown');
      const role_id = roleDropdown.value;
      const enabled = document.getElementById('enabledCheckbox').checked;
      const sponsor_name = (window.loggedInEmail || '');
      const sponsor_profile = "1";
      let expire_time = 0;
      const expireInput = document.getElementById('expireTime').value;
      if (expireInput) {
        expire_time = Math.floor(new Date(expireInput).getTime() / 1000);
      }
      const visitor_name = document.getElementById('visitorName').value.trim();
      const payload = {
        mac,
        role_id,
        enabled,
        sponsor_name,
        sponsor_profile,
        expire_time,
        visitor_name
      };
      const result = document.getElementById('postResult');
      result.textContent = 'Sender data...';
      disableButtons(['createDeviceBtn'], true);
      try {
        const response = await fetch('/create_device', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await response.json();
        if (response.ok) {
          result.textContent = JSON.stringify(data, null, 2);
          showToast('Enhet opprettet.');
        } else {
          const msg = data.error || getHttpStatusMessage(response.status);
          result.textContent = `Feil: ${msg}`;
          showToast(msg, 'error');
        }
      } catch (error) {
        result.textContent = `Feil: ${error.message}`;
        showToast(`Feil: ${error.message}`, 'error');
      }
      disableButtons(['createDeviceBtn'], false);
    }

    function formatCodeInput(input) {
      // Always show the dash at position 3 as the user types
      let value = input.value.replace(/[^0-9]/g, '');
      if (value.length > 3) {
        value = value.slice(0, 3) + '-' + value.slice(3, 6);
      }
      input.value = value;
    }

    window.onload = async () => {
      // Check login state from server
      try {
        const response = await fetch('/is_logged_in');
        const data = await response.json();
        setLoggedIn(data.logged_in === true);
      } catch (e) {
        setLoggedIn(false);
      }
      document.getElementById('loginEmail').focus();
    };
  </script>
</body>
</html>