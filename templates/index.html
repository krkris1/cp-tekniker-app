<!DOCTYPE html>
<html lang="no" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Device Management</title>
  <link rel="icon" href="/static/favicon.png" type="image/png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = {
      darkMode: 'media',
    };
  </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <nav class="bg-white dark:bg-gray-800 shadow p-4 flex justify-between items-center">
    <div class="flex items-center space-x-2">
      <i data-lucide="laptop" class="w-5 h-5"></i>
      <span class="font-semibold text-lg">Device Manager</span>
    </div>
    <button id="logoutBtn" onclick="logout()" class="hidden bg-red-600 hover:bg-red-700 text-white px-4 py-1 rounded">Logg ut</button>
  </nav>

  <div class="fixed top-4 right-4 space-y-2 z-50" id="toastContainer"></div>

  <div class="flex justify-center items-center py-10">
    <div class="bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6 w-full max-w-md space-y-6">
      <div id="protectedContent" class="hidden space-y-6">
        <div>
          <h3 class="text-lg font-medium flex items-center gap-2"><i data-lucide="search" class="w-5 h-5"></i> Hent enhetsinfo</h3>
          <input id="macaddr" placeholder="MAC-adresse" class="w-full px-4 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" />
          <button id="getDeviceInfoBtn" onclick="getDeviceInfo()" class="w-full mt-2 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg">Hent info</button>
          <pre id="getResult" class="mt-2 text-sm bg-gray-100 dark:bg-gray-800 p-2 rounded"></pre>
        </div>

        <div>
          <h3 class="text-lg font-medium flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5"></i> Opprett enhet</h3>
          <label for="roleDropdown">Velg rolle:</label>
          <select id="roleDropdown" class="w-full px-4 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700"></select>
          <input id="visitorName" placeholder="Navn pÃ¥ enhet" class="w-full mt-2 px-4 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" />
          <input type="datetime-local" id="expireTime" class="w-full mt-2 px-4 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" />
          <label class="inline-flex items-center gap-2 mt-2">
            <input type="checkbox" id="enabledCheckbox" checked class="h-4 w-4" /> Aktivert
          </label>
          <button id="createDeviceBtn" onclick="createDevice()" class="w-full mt-3 bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg">Opprett enhet</button>
          <pre id="postResult" class="mt-2 text-sm bg-gray-100 dark:bg-gray-800 p-2 rounded"></pre>
        </div>
      </div>
    </div>
  </div>

  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl space-y-4 w-full max-w-sm">
      <h2 class="text-xl font-semibold flex items-center gap-2"><i data-lucide="lock" class="w-5 h-5"></i> Logg inn</h2>
      <input id="loginEmail" type="email" placeholder="E-postadresse" autofocus class="w-full px-4 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" />
      <button id="requestAuthBtn" onclick="requestAuthCode()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">Be om kode</button>
      <input id="authCode" placeholder="Kode (f.eks. 123-456)" maxlength="7" inputmode="numeric" oninput="formatCodeInput(this)" class="w-full px-4 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" />
      <button id="loginBtn" onclick="verifyAuthCode()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded">Logg inn</button>
    </div>
  </div>

  <script>
    lucide.createIcons();

    // ENTER key triggers correct button in login modal
    document.addEventListener('DOMContentLoaded', function() {
      const emailInput = document.getElementById('loginEmail');
      const codeInput = document.getElementById('authCode');
      const requestAuthBtn = document.getElementById('requestAuthBtn');
      const loginBtn = document.getElementById('loginBtn');
      const loginModal = document.getElementById('loginModal');

      emailInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && emailInput.value && !requestAuthBtn.disabled && !loginModal.classList.contains('hidden')) {
          e.preventDefault();
          requestAuthBtn.click();
        }
      });
      codeInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && codeInput.value && !loginBtn.disabled && !loginModal.classList.contains('hidden')) {
          e.preventDefault();
          loginBtn.click();
        }
      });
    });

    function showToast(message, type = "success") {
      const toastContainer = document.getElementById("toastContainer");
      const toast = document.createElement("div");
      const color = type === "error" ? "bg-red-600" : "bg-green-600";
      toast.className = `${color} text-white px-4 py-2 rounded shadow`;
      toast.textContent = message;
      toastContainer.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function formatCodeInput(input) {
      let value = input.value.replace(/[^0-9]/g, "");
      if (value.length > 3) value = value.slice(0, 3) + "-" + value.slice(3);
      input.value = value;
    }

    function disableButtons(ids, disabled = true) {
      ids.forEach(id => document.getElementById(id).disabled = disabled);
    }

    async function requestAuthCode() {
      const email = document.getElementById("loginEmail").value;
      showToast("Sender kode...");
      disableButtons(["requestAuthBtn"]);
      try {
        const response = await fetch("/request_auth_code", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email })
        });
        const data = await response.json();
        if (response.ok) showToast(data.message || "Kode sendt.");
        else showToast(data.error || "Feil", "error");
      } catch (e) {
        showToast("Nettverksfeil", "error");
      }
      disableButtons(["requestAuthBtn"], false);
    }

    async function verifyAuthCode() {
      const email = document.getElementById("loginEmail").value;
      const code = document.getElementById("authCode").value.replace(/[^0-9]/g, "").replace(/(.{3})/, "$1-");
      showToast("Verifiserer...");
      disableButtons(["loginBtn", "requestAuthBtn"]);
      try {
        const response = await fetch("/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, code })
        });
        const data = await response.json();
        if (response.ok) {
          showToast("Innlogging vellykket.");
          window.loggedInEmail = email;
          setLoggedIn(true);
        } else {
          showToast(data.error || "Feil", "error");
        }
      } catch (e) {
        showToast("Nettverksfeil", "error");
      }
      disableButtons(["loginBtn", "requestAuthBtn"], false);
    }

    async function logout() {
      await fetch("/logout", { method: "POST" });
      setLoggedIn(false);
      showToast("Du er logget ut.");
    }

    function setLoggedIn(loggedIn) {
      document.getElementById("loginModal").classList.toggle("hidden", loggedIn);
      document.getElementById("protectedContent").classList.toggle("hidden", !loggedIn);
      document.getElementById("logoutBtn").classList.toggle("hidden", !loggedIn);
      if (loggedIn) fetchDeviceRoles();
    }

    async function fetchDeviceRoles() {
      try {
        const response = await fetch("/GetDeviceRoles");
        const data = await response.json();
        const dropdown = document.getElementById("roleDropdown");
        dropdown.innerHTML = "";
        (data._embedded?.items || data || []).forEach(role => {
          const option = document.createElement("option");
          option.value = role.role_id || role.id || role.name;
          option.textContent = role.name;
          dropdown.appendChild(option);
        });
      } catch {
        showToast("Feil ved henting av roller", "error");
      }
    }

    async function getDeviceInfo() {
      const macaddr = document.getElementById("macaddr").value;
      const result = document.getElementById("getResult");
      result.textContent = "Laster...";
      disableButtons(["getDeviceInfoBtn"]);
      try {
        const response = await fetch(`/get_device_info?macaddr=${encodeURIComponent(macaddr)}`);
        const data = await response.json();
        if (response.ok) {
          result.textContent = JSON.stringify(data, null, 2);
          showToast("Enhetsinfo hentet.");
        } else {
          showToast(data.error || "Feil", "error");
          result.textContent = "Feil: " + (data.error || "");
        }
      } catch (e) {
        result.textContent = "Feil: " + e.message;
        showToast("Nettverksfeil", "error");
      }
      disableButtons(["getDeviceInfoBtn"], false);
    }

    async function createDevice() {
      const mac = document.getElementById("macaddr").value.trim();
      const role_id = document.getElementById("roleDropdown").value;
      const enabled = document.getElementById("enabledCheckbox").checked;
      const visitor_name = document.getElementById("visitorName").value.trim();
      const expireInput = document.getElementById("expireTime").value;
      const sponsor_name = window.loggedInEmail || "";
      const sponsor_profile = "1";
      const expire_time = expireInput ? Math.floor(new Date(expireInput).getTime() / 1000) : 0;
      const payload = { mac, role_id, enabled, visitor_name, expire_time, sponsor_name, sponsor_profile };
      const result = document.getElementById("postResult");
      result.textContent = "Sender...";
      disableButtons(["createDeviceBtn"]);
      try {
        const response = await fetch("/create_device", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await response.json();
        if (response.ok) {
          result.textContent = JSON.stringify(data, null, 2);
          showToast("Enhet opprettet.");
        } else {
          result.textContent = "Feil: " + (data.error || "");
          showToast(data.error || "Feil", "error");
        }
      } catch (e) {
        result.textContent = "Feil: " + e.message;
        showToast("Nettverksfeil", "error");
      }
      disableButtons(["createDeviceBtn"], false);
    }

    window.onload = async () => {
      try {
        const response = await fetch("/is_logged_in");
        const data = await response.json();
        setLoggedIn(data.logged_in === true);
      } catch {
        setLoggedIn(false);
      }
    }
  </script>
</body>
</html>
